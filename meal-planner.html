<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–µ–Ω—é + —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ (–¥–Ω–∏, —Ç–∏–ø –±–ª—é–¥–∞, —Ä—É—á–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏)</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#1f2937; --acc:#22c55e;
    --text:#e5e7eb; --sub:#9ca3af; --border:#374151;
    --bad:#ef4444; --good:#22c55e; --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:linear-gradient(145deg,#0b1226,#0f172a 40%,#0b1226);
    color:var(--text); font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    padding:24px;
  }
  h1{font-size:24px;margin:0 0 12px}
  .wrap{max-width:1100px;margin:0 auto;display:grid;gap:16px}
  .card{
    background:rgba(17,24,39,.9); border:1px solid var(--border); border-radius:14px; padding:16px;
    backdrop-filter:saturate(140%) blur(8px); box-shadow:0 8px 28px rgba(0,0,0,.35);
  }
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
  label{color:var(--sub); font-weight:600}
  input[type="number"], select, input[type="text"]{
    background:var(--muted); color:var(--text); border:1px solid var(--border);
    border-radius:10px; padding:8px 10px; outline:none; width:100%;
  }
  select{min-width:170px}
  button{
    background:var(--acc); color:#07210f; border:none; padding:10px 14px; border-radius:12px;
    font-weight:700; cursor:pointer; transition:transform .04s ease,opacity .2s ease; white-space:nowrap;
  }
  button:hover{transform:translateY(-1px)}
  button.ghost{background:transparent; color:var(--text); border:1px solid var(--border)}
  button.bad{background:var(--bad); color:#fff}
  button.warn{background:var(--warn); color:#111}
  .grid{
    display:grid; gap:10px;
    grid-template-columns: 140px repeat(3, 1fr);
  }
  .cell{background:var(--muted); padding:8px; border:1px solid var(--border); border-radius:10px}
  .head{background:transparent; border:none; color:var(--sub); font-weight:800}
  .day{display:flex;align-items:center;gap:8px;font-weight:700}
  .mealCell{display:grid; grid-template-columns: 1fr 78px; gap:8px; align-items:center}
  .qtyWrap{display:flex; gap:6px; align-items:center}
  .qtyWrap input{max-width:68px; text-align:center}
  .qtyWrap .lbl{color:var(--sub); font-size:12px}
  .footer{display:flex;gap:10px;flex-wrap:wrap}
  .muted{color:var(--sub); font-size:13px}
  .two-col{display:grid; grid-template-columns: 1fr 1fr; gap:16px}
  @media (max-width: 900px){
    .grid{grid-template-columns: 110px 1fr}
    .grid .cell.meal{grid-column:2 / -1}
    .two-col{grid-template-columns:1fr}
    .mealCell{grid-template-columns: 1fr}
  }
  ul.clean{margin:0; padding-left:18px}
  .tag{display:inline-flex;align-items:center;gap:8px; background:var(--muted); border:1px solid var(--border);
       padding:6px 10px; border-radius:999px}
  .pill{background:#0ea5e9; color:#082231; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800}
  .tbl{width:100%; border-collapse:collapse; font-size:14px}
  .tbl th,.tbl td{border-bottom:1px solid var(--border); padding:8px; vertical-align:top}
  .tbl th{color:var(--sub); text-align:left}
  .right{display:flex;gap:8px;justify-content:flex-end}
  .ing{display:grid; grid-template-columns: 2fr .6fr .6fr; gap:8px}
  .small{font-size:12px}
  .code{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; background:var(--muted);
        border:1px dashed var(--border); padding:6px 8px; border-radius:8px}
  .daysFilter{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
  .chips{display:flex; gap:6px; flex-wrap:wrap}
  .chip{background:var(--muted); border:1px solid var(--border); padding:6px 10px; border-radius:999px; cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <h1>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –º–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>
    <span class="tag">–ë–∞–∑. –ø–æ—Ä—Ü–∏–π –Ω–∞ –ø—Ä–∏—ë–º: <span id="serv-pill" class="pill">2</span></span>
  </div>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Ñ–∏–ª—å—Ç—Ä –¥–Ω–µ–π -->
  <div class="card">
    <div class="row">
      <label for="servings">–ü–æ—Ä—Ü–∏–π –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞:</label>
      <input type="number" id="servings" min="1" step="1" value="1" style="max-width:110px">
      <label for="people">–õ—é–¥–µ–π:</label>
      <input type="number" id="people" min="1" step="1" value="2" style="max-width:110px">
      <button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ–Ω—é</button>
      <button id="clearWeekBtn" class="warn">–û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—é</button>
      <button id="resetBtn" class="bad">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
      <div style="flex:1"></div>
      <button id="printBtn" class="ghost">–ü–µ—á–∞—Ç—å</button>
      <button id="exportBtn" class="ghost">–≠–∫—Å–ø–æ—Ä—Ç JSON</button>
      <button id="importBtn" class="ghost">–ò–º–ø–æ—Ä—Ç JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>

    <div class="row" style="margin-top:10px">
      <label>–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–æ–∫—É–ø–∫–∏ –¥–ª—è:</label>
      <div id="daysFilter" class="daysFilter"></div>
      <div class="chips">
        <button id="fltAll" class="ghost">–í—Å–µ</button>
        <button id="fltWork" class="ghost">–ë—É–¥–Ω–∏</button>
        <button id="fltWend" class="ghost">–í—ã—Ö–æ–¥–Ω—ã–µ</button>
      </div>
    </div>

    <div class="muted small" style="margin-top:8px">
      –§–æ—Ä–º—É–ª–∞ –ø–æ—Ä—Ü–∏–π: <span class="code">–ö–æ–ª-–≤–æ = (–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç –Ω–∞ 1 –ø–æ—Ä—Ü–∏—é) √ó –ª—é–¥–µ–π √ó –±–∞–∑. –ø–æ—Ä—Ü–∏–∏ √ó (—Ä—É—á–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏ —è—á–µ–π–∫–∏)</span>
    </div>
  </div>

  <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
  <div class="card">
    <div class="grid" id="planner"></div>
  </div>

  <div class="two-col">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">üõí –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ (–ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–Ω—è–º)</h3>
        <div class="right">
          <button id="copyList">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      </div>
      <div id="shoppingList" class="muted" style="margin-top:8px">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–∞ ‚Äî —Å–ø–∏—Å–æ–∫ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –±–ª—é–¥</h3>
        <div class="right">
          <button id="addDishBtn">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>
          <button id="resetDishes" class="ghost">–°–±—Ä–æ—Å–∏—Ç—å –∫ —à–∞–±–ª–æ–Ω—É</button>
        </div>
      </div>
      <table class="tbl" id="dishTable">
        <thead>
          <tr>
            <th style="width:22%">–ë–ª—é–¥–æ</th>
            <th style="width:120px">–¢–∏–ø</th>
            <th>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã (–Ω–∞ 1 –ø–æ—Ä—Ü–∏—é)</th>
            <th style="width:120px"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="muted small">–§–æ—Ä–º–∞—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞: <span class="code">–Ω–∞–∑–≤–∞–Ω–∏–µ | –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ | –µ–¥.</span>. –ü—Ä–∏–º–µ—Ä: <em>—Ä–∏—Å | 70 | –≥</em></div>
    </div>
  </div>

  <div class="card">
    <details>
      <summary><strong>‚ÑπÔ∏è –ü–æ–¥—Å–∫–∞–∑–∫–∏</strong></summary>
      <ul class="clean">
        <li>–í –∫–∞–∂–¥–æ–π —è—á–µ–π–∫–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –±–ª—é–¥–æ –∏ —É–∫–∞–∑–∞—Ç—å <strong>—Ä—É—á–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏</strong> (–º–Ω–æ–∂–∏—Ç–µ–ª—å).</li>
        <li>–°–ø–∏—Å–æ–∫ –±–ª—é–¥ –≤ —è—á–µ–π–∫–∞—Ö —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è –ø–æ —Ç–∏–ø—É –ø—Ä–∏—ë–º–∞ –ø–∏—â–∏ (–ó–∞–≤—Ç—Ä–∞–∫/–û–±–µ–¥/–£–∂–∏–Ω/–õ—é–±–æ–µ).</li>
        <li>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ —Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ <strong>–≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–Ω—è–º</strong> (–≥–∞–ª–æ—á–∫–∏ —Å–≤–µ—Ä—Ö—É).</li>
        <li>–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (localStorage). –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç ‚Äî –≤ JSON.</li>
      </ul>
    </details>
  </div>
</div>

<script>
(function(){
  const DAYS = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫","–í—Ç–æ—Ä–Ω–∏–∫","–°—Ä–µ–¥–∞","–ß–µ—Ç–≤–µ—Ä–≥","–ü—è—Ç–Ω–∏—Ü–∞","–°—É–±–±–æ—Ç–∞","–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"];
  const MEALS = ["–ó–∞–≤—Ç—Ä–∞–∫","–û–±–µ–¥","–£–∂–∏–Ω"];
  const MEAL_TYPES = ["–õ—é–±–æ–µ","–ó–∞–≤—Ç—Ä–∞–∫","–û–±–µ–¥","–£–∂–∏–Ω"];

  const LS_KEYS = {
    DISHES: "mealPlanner.dishes.v2",
    WEEK: "mealPlanner.week.v2",
    SETTINGS: "mealPlanner.settings.v1",
    FILTER: "mealPlanner.filterDays.v1"
  };

  // --- —à–∞–±–ª–æ–Ω –±–ª—é–¥ —Å —Ç–∏–ø–∞–º–∏
  const templateDishes = [
    { name:"–û–≤—Å—è–Ω–∫–∞", type:"–ó–∞–≤—Ç—Ä–∞–∫",
      ingredients:[ {n:"–æ–≤—Å—è–Ω—ã–µ —Ö–ª–æ–ø—å—è",q:50,u:"–≥"}, {n:"–º–æ–ª–æ–∫–æ",q:200,u:"–º–ª"}, {n:"—è–±–ª–æ–∫–æ",q:0.5,u:"—à—Ç"}, {n:"–º—ë–¥",q:1,u:"—Å—Ç.–ª."} ] },
    { name:"–û–º–ª–µ—Ç —Å –æ–≤–æ—â–∞–º–∏", type:"–ó–∞–≤—Ç—Ä–∞–∫",
      ingredients:[ {n:"—è–π—Ü–∞",q:2,u:"—à—Ç"}, {n:"–º–æ–ª–æ–∫–æ",q:30,u:"–º–ª"}, {n:"–ø–æ–º–∏–¥–æ—Ä",q:0.5,u:"—à—Ç"}, {n:"–ø–µ—Ä–µ—Ü —Å–ª–∞–¥–∫–∏–π",q:0.25,u:"—à—Ç"}, {n:"–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ",q:1,u:"—á.–ª."} ] },
    { name:"–°—É–ø —á–µ—á–µ–≤–∏—á–Ω—ã–π", type:"–û–±–µ–¥",
      ingredients:[ {n:"—á–µ—á–µ–≤–∏—Ü–∞",q:80,u:"–≥"}, {n:"–º–æ—Ä–∫–æ–≤—å",q:0.5,u:"—à—Ç"}, {n:"–ª—É–∫",q:0.5,u:"—à—Ç"}, {n:"—Ç–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞",q:1,u:"—Å—Ç.–ª."}, {n:"–º–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ",q:1,u:"—Å—Ç.–ª."}, {n:"—Å–ø–µ—Ü–∏–∏",q:1,u:"—â–µ–ø–æ—Ç–∫–∞"} ] },
    { name:"–ö—É—Ä–∏—Ü–∞ —Å —Ä–∏—Å–æ–º", type:"–£–∂–∏–Ω",
      ingredients:[ {n:"–∫—É—Ä–∏–Ω–∞—è –≥—Ä—É–¥–∫–∞",q:150,u:"–≥"}, {n:"—Ä–∏—Å",q:70,u:"–≥"}, {n:"–º–∞—Å–ª–æ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ",q:1,u:"—Å—Ç.–ª."}, {n:"—Å–ø–µ—Ü–∏–∏",q:1,u:"—â–µ–ø–æ—Ç–∫–∞"} ] },
    { name:"–ü–∞—Å—Ç–∞ —Å –æ–≤–æ—â–∞–º–∏", type:"–û–±–µ–¥",
      ingredients:[ {n:"–º–∞–∫–∞—Ä–æ–Ω—ã",q:100,u:"–≥"}, {n:"–∫–∞–±–∞—á–æ–∫",q:0.5,u:"—à—Ç"}, {n:"—Ç–æ–º–∞—Ç",q:1,u:"—à—Ç"}, {n:"—á–µ—Å–Ω–æ–∫",q:1,u:"–∑—É–±—á–∏–∫"}, {n:"–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ",q:1,u:"—Å—Ç.–ª."} ] },
    { name:"–†—ã–±–∞ –∑–∞–ø–µ—á—ë–Ω–Ω–∞—è", type:"–£–∂–∏–Ω",
      ingredients:[ {n:"—Ñ–∏–ª–µ —Ä—ã–±—ã",q:160,u:"–≥"}, {n:"–ª–∏–º–æ–Ω",q:0.25,u:"—à—Ç"}, {n:"–º–∞—Å–ª–æ –æ–ª–∏–≤–∫–æ–≤–æ–µ",q:1,u:"—Å—Ç.–ª."}, {n:"—Å–æ–ª—å",q:1,u:"—â–µ–ø–æ—Ç–∫–∞"} ] },
    { name:"–°–∞–ª–∞—Ç –≥—Ä–µ—á–µ—Å–∫–∏–π", type:"–õ—é–±–æ–µ",
      ingredients:[ {n:"–æ–≥—É—Ä–µ—Ü",q:0.5,u:"—à—Ç"}, {n:"–ø–æ–º–∏–¥–æ—Ä",q:1,u:"—à—Ç"}, {n:"–ø–µ—Ä–µ—Ü —Å–ª–∞–¥–∫–∏–π",q:0.25,u:"—à—Ç"}, {n:"—Ñ–µ—Ç–∞",q:60,u:"–≥"}, {n:"–æ–ª–∏–≤–∫–∏",q:40,u:"–≥"}, {n:"–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ",q:1,u:"—Å—Ç.–ª."} ] },
    { name:"–ë–æ—Ä—â –±—ã—Å—Ç—Ä—ã–π", type:"–û–±–µ–¥",
      ingredients:[ {n:"—Å–≤–µ–∫–ª–∞",q:0.5,u:"—à—Ç"}, {n:"–∫–∞–ø—É—Å—Ç–∞",q:150,u:"–≥"}, {n:"–º–æ—Ä–∫–æ–≤—å",q:0.5,u:"—à—Ç"}, {n:"–ª—É–∫",q:0.5,u:"—à—Ç"}, {n:"—Ç–æ–º–∞—Ç–Ω–∞—è –ø–∞—Å—Ç–∞",q:1,u:"—Å—Ç.–ª."} ] },
    { name:"–õ–æ—Å–æ—Å—å —Å –±—É–ª–≥—É—Ä–æ–º", type:"–£–∂–∏–Ω",
      ingredients:[ {n:"–ª–æ—Å–æ—Å—å",q:170,u:"–≥"}, {n:"–±—É–ª–≥—É—Ä",q:70,u:"–≥"}, {n:"–ª–∏–º–æ–Ω",q:0.25,u:"—à—Ç"}, {n:"–æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ",q:1,u:"—Å—Ç.–ª."} ] },
    { name:"–°—ç–Ω–¥–≤–∏—á —Å –∏–Ω–¥–µ–π–∫–æ–π", type:"–õ—é–±–æ–µ",
      ingredients:[ {n:"—Ö–ª–µ–±",q:2,u:"–ª–æ–º—Ç"}, {n:"–∏–Ω–¥–µ–π–∫–∞ (–Ω–∞—Ä–µ–∑–∫–∞)",q:60,u:"–≥"}, {n:"—Å—ã—Ä",q:30,u:"–≥"}, {n:"–ª–∏—Å—Ç—å—è —Å–∞–ª–∞—Ç–∞",q:2,u:"—à—Ç"} ] }
  ];

  // --- —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  let dishes = load(LS_KEYS.DISHES) || templateDishes;
  let week = migrateWeek(load(LS_KEYS.WEEK)) || initEmptyWeek(); // —Å qty
  let settings = load(LS_KEYS.SETTINGS) || { people: 2, servingsPerPerson: 1 };
  let filterDays = load(LS_KEYS.FILTER) || DAYS.slice(); // –≤—Å–µ –≤–∫–ª—é—á–µ–Ω—ã

  // —ç–ª–µ–º–µ–Ω—Ç—ã
  const plannerEl = document.getElementById("planner");
  const shoppingEl = document.getElementById("shoppingList");
  const peopleEl = document.getElementById("people");
  const servEl = document.getElementById("servings");
  const servPill = document.getElementById("serv-pill");
  const daysFilterEl = document.getElementById("daysFilter");

  // –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–Ω–µ–π
  function renderDayFilter(){
    daysFilterEl.innerHTML = "";
    DAYS.forEach(d=>{
      const id = "day-" + d;
      const label = document.createElement("label");
      label.style.display="inline-flex"; label.style.alignItems="center"; label.style.gap="6px";
      const cb = document.createElement("input"); cb.type="checkbox"; cb.id=id; cb.checked = filterDays.includes(d);
      cb.addEventListener("change", ()=>{
        if(cb.checked){ if(!filterDays.includes(d)) filterDays.push(d); }
        else{ filterDays = filterDays.filter(x=>x!==d); }
        save(LS_KEYS.FILTER, filterDays);
        recompute();
      });
      label.appendChild(cb);
      const txt = document.createElement("span"); txt.textContent = d;
      label.appendChild(txt);
      daysFilterEl.appendChild(label);
    });

    document.getElementById("fltAll").onclick = ()=>{ filterDays = DAYS.slice(); save(LS_KEYS.FILTER, filterDays); renderDayFilter(); recompute(); };
    document.getElementById("fltWork").onclick = ()=>{ filterDays = DAYS.slice(0,5); save(LS_KEYS.FILTER, filterDays); renderDayFilter(); recompute(); };
    document.getElementById("fltWend").onclick = ()=>{ filterDays = DAYS.slice(5); save(LS_KEYS.FILTER, filterDays); renderDayFilter(); recompute(); };
  }

  // –∫–∞–ª–µ–Ω–¥–∞—Ä—å
  function renderPlanner(){
    plannerEl.innerHTML = "";
    addCell("–î–µ–Ω—å", true);
    MEALS.forEach(m=> addCell(m, true));
    DAYS.forEach(day=>{
      addCell(day, false, "day");
      MEALS.forEach(meal=>{
        const cell = addCell("", false, "meal");
        const wrap = document.createElement("div");
        wrap.className = "mealCell";

        // select –±–ª—é–¥ –ø–æ —Ç–∏–ø—É
        const select = document.createElement("select");
        const noneOpt = document.createElement("option"); noneOpt.value = ""; noneOpt.textContent = "‚Äî –Ω–µ –≤—ã–±—Ä–∞–Ω–æ ‚Äî";
        select.appendChild(noneOpt);
        dishes
          .slice()
          .sort((a,b)=>a.name.localeCompare(b.name,"ru"))
          .filter(d=> d.type==="–õ—é–±–æ–µ" || d.type===meal)
          .forEach(d=>{
            const opt = document.createElement("option");
            opt.value = d.name; opt.textContent = `${d.name}`;
            select.appendChild(opt);
          });

        // qty –Ω–∞ —è—á–µ–π–∫—É (—Ä—É—á–Ω—ã–µ –ø–æ—Ä—Ü–∏–∏)
        const qtyWrap = document.createElement("div");
        qtyWrap.className = "qtyWrap";
        const qtyLbl = document.createElement("span"); qtyLbl.className="lbl"; qtyLbl.textContent = "–ü–æ—Ä—Ü.:";
        const qtyInput = document.createElement("input"); qtyInput.type="number"; qtyInput.min="0"; qtyInput.step="0.5"; qtyInput.value="1";

        // –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
        const stored = week[day]?.[meal];
        if(typeof stored === "string"){
          select.value = stored || "";
          qtyInput.value = 1;
        }else if(stored && typeof stored === "object"){
          select.value = stored.dish || "";
          qtyInput.value = stored.qty ?? 1;
        }

        select.addEventListener("change", ()=>{
          week[day][meal] = { dish: select.value, qty: clampNum(qtyInput.value,0,99,1) };
          save(LS_KEYS.WEEK, week);
          recompute();
        });
        qtyInput.addEventListener("change", ()=>{
          week[day][meal] = { dish: select.value, qty: clampNum(qtyInput.value,0,99,1) };
          save(LS_KEYS.WEEK, week);
          recompute();
        });

        qtyWrap.append(qtyLbl, qtyInput);
        wrap.append(select, qtyWrap);
        cell.appendChild(wrap);
      });
    });
  }

  function addCell(text, head=false, extraClass=""){
    const div = document.createElement("div");
    div.className = "cell " + (head? "head":"") + " " + extraClass;
    if(text) div.textContent = text;
    plannerEl.appendChild(div);
    return div;
  }

  function initEmptyWeek(){
    const obj = {};
    DAYS.forEach(d=>{
      obj[d] = {}; MEALS.forEach(m=> obj[d][m] = { dish:"", qty:1 });
    });
    return obj;
  }
  // –º–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ (—Å—Ç—Ä–æ–∫–∞ -> –æ–±—ä–µ–∫—Ç —Å qty)
  function migrateWeek(w){
    if(!w) return null;
    const out = {};
    for(const d of DAYS){
      out[d] = {};
      for(const m of MEALS){
        const v = w[d]?.[m];
        if(typeof v === "string") out[d][m] = { dish: v || "", qty: 1 };
        else if(v && typeof v === "object") out[d][m] = { dish: v.dish || "", qty: v.qty ?? 1 };
        else out[d][m] = { dish:"", qty:1 };
      }
    }
    return out;
  }

  function recompute(){
    // –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
    const counts = {}; // key: name|unit -> qty
    const people = clampInt(peopleEl.value,1,32);
    const servPer = clampInt(servEl.value,1,8);
    servPill.textContent = String(people * servPer);

    for(const day of DAYS){
      if(!filterDays.includes(day)) continue; // —Ñ–∏–ª—å—Ç—Ä –¥–Ω–µ–π
      for(const meal of MEALS){
        const entry = week[day][meal];
        const dishName = (typeof entry==="object") ? entry.dish : entry;
        const cellQty = (typeof entry==="object") ? (entry.qty ?? 1) : 1;
        if(!dishName) continue;
        const dish = dishes.find(d=>d.name===dishName);
        if(!dish) continue;

        dish.ingredients.forEach(ing=>{
          const key = (ing.n.trim().toLowerCase()) + "|" + (ing.u||"");
          const add = (parseFloat(ing.q)||0) * people * servPer * (parseFloat(cellQty)||1);
          counts[key] = (counts[key]||0) + add;
        });
      }
    }

    // —Ä–µ–Ω–¥–µ—Ä —Å–ø–∏—Å–∫–∞
    if(Object.keys(counts).length===0){
      shoppingEl.innerHTML = `<div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –±–ª—é–¥–∞ ‚Äî —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å.</div>`;
      return;
    }
    const rows = Object.entries(counts).map(([key,qty])=>{
      const [name, unit] = key.split("|");
      return {name:capitalize(name), qty:roundSmart(qty), unit};
    }).sort((a,b)=> a.name.localeCompare(b.name,"ru"));

    const ul = document.createElement("ul");
    ul.className="clean";
    rows.forEach(r=>{
      const li = document.createElement("li");
      li.textContent = `${r.name} ‚Äî ${fmtQty(r.qty)} ${r.unit || ""}`.trim();
      ul.appendChild(li);
    });

    const summary = document.createElement("div");
    summary.className="muted small";
    summary.textContent = `–ü–æ–∫—É–ø–æ–∫: ${rows.length}. –î–Ω–∏: ${filterDays.join(", ")}. –ë–∞–∑. –ø–æ—Ä—Ü–∏–π –Ω–∞ –ø—Ä–∏—ë–º: ${people*servPer}.`;

    shoppingEl.innerHTML = "";
    shoppingEl.appendChild(ul);
    shoppingEl.appendChild(summary);
  }

  // —É—Ç–∏–ª–∏—Ç—ã
  function fmtQty(q){ return (q % 1 === 0) ? q.toString() : q.toFixed(2).replace(/\.00$/,""); }
  function roundSmart(x){ return Math.round(x*100)/100; }
  function capitalize(s){ return s? s.charAt(0).toUpperCase()+s.slice(1) : ""; }
  function clampInt(v,min,max){ v=parseInt(v,10); if(isNaN(v)) v=min; return Math.min(max, Math.max(min, v)); }
  function clampNum(v,min,max,def){ v=parseFloat(v); if(isNaN(v)) v=def; return Math.min(max, Math.max(min, v)); }
  function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
  function load(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch{ return null; } }

  // --- —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –±–ª—é–¥ (CRUD) + –ø–æ–ª–µ ¬´–¢–∏–ø¬ª
  const dishTableBody = document.querySelector("#dishTable tbody");
  function renderDishes(){
    dishTableBody.innerHTML = "";
    dishes.forEach((d,idx)=>{
      const tr = document.createElement("tr");
      const tdName = document.createElement("td");
      const tdType = document.createElement("td");
      const tdIngs = document.createElement("td");
      const tdAct = document.createElement("td");

      const nameInput = document.createElement("input");
      nameInput.type="text"; nameInput.value=d.name;
      nameInput.addEventListener("change", ()=>{
        d.name = nameInput.value.trim(); save(LS_KEYS.DISHES, dishes); renderPlanner(); recompute();
      });
      tdName.appendChild(nameInput);

      const typeSel = document.createElement("select");
      MEAL_TYPES.forEach(t=>{
        const o = document.createElement("option"); o.value=t; o.textContent=t; typeSel.appendChild(o);
      });
      typeSel.value = d.type || "–õ—é–±–æ–µ";
      typeSel.addEventListener("change", ()=>{
        d.type = typeSel.value; save(LS_KEYS.DISHES, dishes); renderPlanner(); recompute();
      });
      tdType.appendChild(typeSel);

      const wrap = document.createElement("div"); wrap.className="ing";
      function renderIngRows(){
        wrap.innerHTML="";
        d.ingredients.forEach((ing,i)=>{
          const in1 = document.createElement("input"); in1.placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"; in1.value=ing.n||"";
          const in2 = document.createElement("input"); in2.placeholder="–ö–æ–ª-–≤–æ"; in2.type="number"; in2.step="0.01"; in2.value=ing.q||0;
          const in3 = document.createElement("input"); in3.placeholder="–ï–¥. (–≥, –º–ª, —à—Ç‚Ä¶)"; in3.value=ing.u||"";
          [in1,in2,in3].forEach(el=> el.addEventListener("change", ()=>{
            d.ingredients[i] = { n: in1.value.trim(), q: parseFloat(in2.value)||0, u: in3.value.trim() };
            save(LS_KEYS.DISHES, dishes); recompute();
          }));
          wrap.append(in1,in2,in3);
        });
      }
      renderIngRows();

      const addIngBtn = document.createElement("button");
      addIngBtn.textContent="–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç";
      addIngBtn.className="ghost";
      addIngBtn.addEventListener("click", ()=>{
        d.ingredients.push({n:"",q:0,u:""});
        save(LS_KEYS.DISHES, dishes); renderDishes(); recompute();
      });

      const delBtn = document.createElement("button"); delBtn.textContent="–£–¥–∞–ª–∏—Ç—å"; delBtn.className="bad";
      delBtn.addEventListener("click", ()=>{
        if(confirm(`–£–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ ¬´${d.name}¬ª?`)){
          dishes.splice(idx,1); save(LS_KEYS.DISHES, dishes);
          renderDishes(); renderPlanner(); recompute();
        }
      });

      tdIngs.appendChild(wrap);
      tdAct.appendChild(addIngBtn);
      tdAct.appendChild(document.createElement("div")).style.height="6px";
      tdAct.appendChild(delBtn);

      tr.append(tdName, tdType, tdIngs, tdAct);
      dishTableBody.appendChild(tr);
    });
  }

  // —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  document.getElementById("addDishBtn").addEventListener("click", ()=>{
    dishes.push({name:"–ù–æ–≤–æ–µ –±–ª—é–¥–æ", type:"–õ—é–±–æ–µ", ingredients:[{n:"–∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç", q:1, u:"—à—Ç"}]});
    save(LS_KEYS.DISHES, dishes); renderDishes(); renderPlanner();
  });

  document.getElementById("resetDishes").addEventListener("click", ()=>{
    if(confirm("–°–±—Ä–æ—Å–∏—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –±–ª—é–¥ –∫ —à–∞–±–ª–æ–Ω—É? –í–∞—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.")){
      dishes = JSON.parse(JSON.stringify(templateDishes));
      save(LS_KEYS.DISHES, dishes); renderDishes(); renderPlanner(); recompute();
    }
  });

  peopleEl.value = settings.people;
  servEl.value = settings.servingsPerPerson;
  peopleEl.addEventListener("change", ()=>{ settings.people=clampInt(peopleEl.value,1,32); save(LS_KEYS.SETTINGS, settings); recompute(); });
  servEl.addEventListener("change", ()=>{ settings.servingsPerPerson=clampInt(servEl.value,1,8); save(LS_KEYS.SETTINGS, settings); recompute(); });

  document.getElementById("saveBtn").addEventListener("click", ()=>{
    save(LS_KEYS.WEEK, week);
    toast("–ú–µ–Ω—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ");
  });
  document.getElementById("clearWeekBtn").addEventListener("click", ()=>{
    if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –±–ª—é–¥–∞ –∑–∞ –Ω–µ–¥–µ–ª—é?")){
      week = initEmptyWeek(); save(LS_KEYS.WEEK, week); renderPlanner(); recompute();
    }
  });
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    if(confirm("–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö (–º–µ–Ω—é, –±–ª—é–¥–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)?")){
      localStorage.removeItem(LS_KEYS.WEEK);
      localStorage.removeItem(LS_KEYS.DISHES);
      localStorage.removeItem(LS_KEYS.SETTINGS);
      localStorage.removeItem(LS_KEYS.FILTER);
      dishes = JSON.parse(JSON.stringify(templateDishes));
      week = initEmptyWeek();
      settings = {people:2, servingsPerPerson:1};
      filterDays = DAYS.slice();
      peopleEl.value = settings.people; servEl.value = settings.servingsPerPerson;
      renderDayFilter();
      renderPlanner(); renderDishes(); recompute();
    }
  });
  document.getElementById("printBtn").addEventListener("click", ()=> window.print());

  // —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç
  document.getElementById("exportBtn").addEventListener("click", ()=>{
    const data = { version:2, settings, dishes, week, filterDays };
    const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "meal-planner-export.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });
  document.getElementById("importBtn").addEventListener("click", ()=> document.getElementById("importFile").click());
  document.getElementById("importFile").addEventListener("change", (e)=>{
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        if(data.dishes) dishes = data.dishes;
        if(data.week) week = migrateWeek(data.week);
        if(data.settings) settings = data.settings;
        if(data.filterDays) filterDays = data.filterDays;
        peopleEl.value = settings.people; servEl.value = settings.servingsPerPerson;
        save(LS_KEYS.DISHES, dishes); save(LS_KEYS.WEEK, week); save(LS_KEYS.SETTINGS, settings); save(LS_KEYS.FILTER, filterDays);
        renderDayFilter();
        renderPlanner(); renderDishes(); recompute();
        toast("–î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã ‚úÖ");
      }catch(err){
        alert("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: " + err.message);
      }
    };
    reader.readAsText(file);
    e.target.value="";
  });

  // –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫
  document.getElementById("copyList").addEventListener("click", ()=>{
    const text = Array.from(document.querySelectorAll("#shoppingList li")).map(li=>"- "+li.textContent).join("\n");
    if(!text){ toast("–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç üòÖ"); return; }
    navigator.clipboard.writeText(text).then(()=> toast("–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ üìã")).catch(()=> alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å"));
  });

  // —Ç–æ—Å—Ç
  function toast(msg){
    const t = document.createElement("div");
    t.textContent = msg;
    t.style.position="fixed"; t.style.bottom="18px"; t.style.left="50%"; t.style.transform="translateX(-50%)";
    t.style.background="rgba(34,197,94,.95)"; t.style.color="#06250f"; t.style.padding="8px 12px"; t.style.borderRadius="10px";
    t.style.boxShadow="0 6px 20px rgba(0,0,0,.25)"; t.style.zIndex="9999"; t.style.fontWeight="800";
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.transition="opacity .3s"; t.style.opacity="0"; }, 1200);
    setTimeout(()=> t.remove(), 1600);
  }

  // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  renderDayFilter();
  renderPlanner();
  renderDishes();
  recompute();
})();
</script>
</body>
</html>
